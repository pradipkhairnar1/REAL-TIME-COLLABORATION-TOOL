<!DOCTYPE html>
<html>
<head>
    <title>Live Collaborative Document</title>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body{
            font-family: Arial;
            margin:40px;
            text-align:center;
        }

        #editor{
            height:400px;
            max-width:900px;
            margin:auto;
        }

        ul{
            list-style:none;
        }

        button{
            padding:8px 14px;
            margin:5px;
            cursor:pointer;
        }
    </style>
</head>

<body>

<h1>ðŸš€ Live Collaborative Document</h1>

<button onclick="newDoc()">ðŸ“„ New Document</button>
<button onclick="changeUser()">ðŸ‘¤ Change Username</button>
<button onclick="copyLink()">ðŸ”— Share</button>

<h3>Active Users:</h3>
<ul id="users"></ul>

<div id="editor"></div>


<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>

// SESSION LOGIN
let username = sessionStorage.getItem("username");

if (!username) {

    username = prompt("Enter your username:");

    while(!username || username.trim() === ""){
        username = prompt("Username cannot be empty:");
    }

    sessionStorage.setItem("username", username);
}


// DOC ID
const params = new URLSearchParams(window.location.search);
let docId = params.get("doc");

if (!docId) {
    docId = crypto.randomUUID();
    window.location.href = `/?doc=${docId}`;
}


// QUILL (PRO SYNC METHOD)
const quill = new Quill('#editor', {
    theme: 'snow'
});

quill.disable();


// SOCKET
const socket = io();

socket.emit("get-document", docId, username);


// LOAD DOC
socket.on("load-document", data=>{
    quill.setContents(data);
    quill.enable();
});


// SEND DELTA 
quill.on("text-change", (delta, oldDelta, source)=>{

    if(source !== "user") return;

    socket.emit("send-changes", delta);
});


// RECEIVE DELTA
socket.on("receive-changes", delta=>{
    quill.updateContents(delta);
});


// AUTOSAVE
setInterval(()=>{
    socket.emit("save-document", quill.getContents());
},2000);


// USERS
socket.on("users", users=>{

    const ul = document.getElementById("users");
    ul.innerHTML = "";

    users.forEach(user=>{
        const li = document.createElement("li");
        li.innerText = user;
        ul.appendChild(li);
    });

});


// BUTTONS
function copyLink(){
    navigator.clipboard.writeText(window.location.href);
    alert("Share link copied!");
}

function newDoc(){
    window.location.href = `/?doc=${crypto.randomUUID()}`;
}

function changeUser(){
    sessionStorage.removeItem("username");
    location.reload();
}

</script>

</body>
</html>
